# syntax=docker/dockerfile:1.4
# =============================================================================
# LiteLLM + LLMRouter Local Development Dockerfile
# =============================================================================
# Optimized for development iteration with local reference/ folder
# Uses uv for fast package management
#
# Usage:
#   docker build -f docker/Dockerfile.local -t litellm-llmrouter:local .
#   docker compose -f docker-compose.local-test.yml up
# =============================================================================

ARG PYTHON_VERSION=3.12
ARG UV_VERSION=0.9
ARG LITELLM_VERSION=1.80.15

FROM ghcr.io/astral-sh/uv:${UV_VERSION}-python${PYTHON_VERSION}-bookworm-slim

ARG LITELLM_VERSION

LABEL org.opencontainers.image.description="LiteLLM + LLMRouter: Local Development Build"
LABEL org.opencontainers.image.version="${LITELLM_VERSION}-dev"

WORKDIR /app

# Install system dependencies (including dev tools)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    ca-certificates \
    tini \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /var/cache/apt/*

# Install LiteLLM with proxy extras
RUN uv pip install --system "litellm[proxy]==${LITELLM_VERSION}"

# Install OpenTelemetry for tracing and Prisma for database
RUN uv pip install --system \
    opentelemetry-api \
    opentelemetry-sdk \
    opentelemetry-exporter-otlp \
    opentelemetry-exporter-otlp-proto-grpc \
    opentelemetry-exporter-otlp-proto-http \
    opentelemetry-instrumentation-fastapi \
    opentelemetry-instrumentation-httpx \
    opentelemetry-instrumentation-logging \
    prisma

# Generate Prisma client (may fail if no schema, that's OK)
RUN prisma generate || true

# Install additional dependencies
COPY requirements.txt /tmp/requirements.txt
RUN uv pip install --system -r /tmp/requirements.txt || true && \
    rm -rf /root/.cache

# Copy and install LLMRouter from local reference (for dev iteration)
COPY reference/LLMRouter /tmp/LLMRouter
RUN cd /tmp/LLMRouter && uv pip install --system . || echo "LLMRouter install skipped" && \
    rm -rf /tmp/LLMRouter

# Copy custom routing integration
COPY src/litellm_llmrouter /app/litellm_llmrouter

# Copy entrypoint and config
COPY docker/entrypoint.local.sh /app/entrypoint.sh
COPY config/ /app/config/

# Create directories
RUN mkdir -p /app/models /app/data /app/custom_routers && \
    chmod +x /app/entrypoint.sh

# Environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONFAULTHANDLER=1 \
    PYTHONPATH=/app \
    LITELLM_CONFIG_PATH=/app/config/config.yaml \
    LLMROUTER_MODELS_PATH=/app/models

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:4000/health/liveliness || exit 1

EXPOSE 4000

# Use tini for proper signal handling
ENTRYPOINT ["/usr/bin/tini", "--", "/app/entrypoint.sh"]
CMD ["--config", "/app/config/config.yaml", "--port", "4000"]
