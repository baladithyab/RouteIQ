# LiteLLM + LLMRouter with Jaeger Tracing
# OTEL setup for local development and E2E testing (TG4.2)
#
# Usage:
#   docker-compose -f docker-compose.otel.yml up -d
#
# Access:
#   - LiteLLM Gateway: http://localhost:4001
#   - Jaeger UI:       http://localhost:16686
#
# TG4.2 E2E Test:
#   uv run pytest tests/integration/test_otel_e2e.py -v -s

services:
  litellm-gateway-otel:
    build:
      context: .
      dockerfile: docker/Dockerfile.local
    container_name: litellm-gateway-otel
    ports:
      - "4001:4000"
    volumes:
      # Use OTel test config (simple-shuffle strategy, no ML model required)
      - ./config/config.otel-test.yaml:/app/config/config.yaml:ro
    environment:
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-dev-key}
      # API Keys (mock - requests will fail but traces will be emitted)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-mock-key}
      # OpenTelemetry Configuration
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=litellm-gateway
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
      - OTEL_LOGS_EXPORTER=none
      # Sample all traces for E2E testing
      - OTEL_TRACES_SAMPLER=always_on
      # Enable router decision callback for TG4.1 attributes
      - LLMROUTER_ROUTER_CALLBACK_ENABLED=true
      - LLMROUTER_ROUTER_CALLBACK_STRATEGY=simple-shuffle
    depends_on:
      - jaeger
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/_health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - otel-network

  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: jaeger-otel
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    restart: unless-stopped
    networks:
      - otel-network

networks:
  otel-network:
    driver: bridge
