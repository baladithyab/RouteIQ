name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  IMAGE_NAME: litellm-llmrouter
  TEST_PORT: 4010

jobs:
  # Detect what changed to optimize CI
  changes:
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      docker: ${{ steps.filter.outputs.docker }}
      compose: ${{ steps.filter.outputs.compose }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'src/**'
              - 'tests/**'
              - 'requirements.txt'
              - 'pyproject.toml'
            docker:
              - 'docker/**'
              - 'src/**'
              - 'requirements.txt'
              - 'config/**'
            compose:
              - 'docker-compose*.yml'
              - 'examples/mlops/docker-compose*.yml'

  lint:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: pip install ruff

      - name: Run ruff check
        run: ruff check src/

      - name: Check formatting with ruff
        run: ruff format --check src/

  test:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install git+https://github.com/ulab-uiuc/LLMRouter.git
          pip install litellm pytest pytest-asyncio
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          pytest tests/test_strategies.py -v --tb=short
        env:
          PYTHONPATH: src

  # Build Docker image and run container smoke tests
  docker-build-and-test:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.docker == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image was built
        run: |
          docker images ${{ env.IMAGE_NAME }}:test
          # Verify image exists and has correct tags
          docker inspect ${{ env.IMAGE_NAME }}:test --format='{{.Id}}' || exit 1
          echo "✅ Image built successfully"

      - name: Verify image labels
        run: |
          echo "Checking OCI labels..."
          docker inspect ${{ env.IMAGE_NAME }}:test --format='{{json .Config.Labels}}' | jq .
          # Verify required labels exist
          docker inspect ${{ env.IMAGE_NAME }}:test --format='{{index .Config.Labels "org.opencontainers.image.source"}}' | grep -q "github.com" || echo "Warning: Missing source label"
          echo "✅ Image labels verified"

      - name: Start container for smoke tests
        run: |
          # Create minimal config for testing
          mkdir -p /tmp/test-config
          cat > /tmp/test-config/config.yaml << 'EOF'
          model_list:
            - model_name: test-model
              litellm_params:
                model: fake-openai-endpoint
                api_key: fake-key
                api_base: http://localhost:8080

          general_settings:
            master_key: sk-test-ci-key

          litellm_settings:
            drop_params: true
          EOF

          # Start container with test config
          docker run -d \
            --name test-container \
            -p ${{ env.TEST_PORT }}:4000 \
            -v /tmp/test-config:/app/config:ro \
            -e LITELLM_CONFIG_PATH=/app/config/config.yaml \
            ${{ env.IMAGE_NAME }}:test

          # Wait for container to start
          echo "Waiting for container to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:${{ env.TEST_PORT }}/health > /dev/null 2>&1; then
              echo "✅ Container is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "❌ Container failed to start"
              docker logs test-container
              exit 1
            fi
            sleep 2
          done

      - name: Run container smoke tests
        run: |
          echo "=== Health Check ==="
          curl -s http://localhost:${{ env.TEST_PORT }}/health | jq . || true

          echo ""
          echo "=== Models Endpoint ==="
          curl -s -H "Authorization: Bearer sk-test-ci-key" \
            http://localhost:${{ env.TEST_PORT }}/v1/models | jq . || true

          echo ""
          echo "=== Verify Process Running ==="
          docker exec test-container ps aux | head -20

          echo ""
          echo "=== Container Logs (last 50 lines) ==="
          docker logs test-container --tail 50

          echo ""
          echo "✅ Smoke tests passed"

      - name: Test container security (non-root)
        run: |
          # Verify container runs as non-root
          USER_ID=$(docker exec test-container id -u)
          if [ "$USER_ID" = "0" ]; then
            echo "❌ Container is running as root (UID 0)"
            exit 1
          fi
          echo "✅ Container running as non-root user (UID: $USER_ID)"

      - name: Cleanup
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true

  validate-compose:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.compose == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config

      - name: Validate docker-compose.ha.yml
        run: docker compose -f docker-compose.ha.yml config

      - name: Validate MLOps compose
        run: docker compose -f examples/mlops/docker-compose.mlops.yml config
